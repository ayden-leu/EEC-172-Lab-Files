
/* These functions are based on the Arduino test program at
*  https://github.com/adafruit/Adafruit-SSD1351-library/blob/master/examples/test/test.ino
*
*  You can use these high-level routines to implement your
*  test program.
*/

// TODO Configure SPI port and use these libraries to implement
// an OLED test program. See SPI example program.

#include "oled_test.h"

#include "Adafruit_GFX.h"
#include "Adafruit_SSD1351.h"
#include "i2c_if.h"

//*****************************************************************************
//  function delays 3*ulCount cycles
static void delay(unsigned long ulCount){
    int i;
    do{
        ulCount--;
        for (i=0; i<65535; i++);
    }while(ulCount);
}

static int ball_x = OLED_W / 2;
static int ball_y = OLED_H / 2;

static int clamp_int(int v, int lo, int hi){
    if (v < lo) return lo;
    if (v > hi) return hi;
    return v;
}

// Draw the ball at current position
void drawBall(void){
    fillCircle(ball_x, ball_y, BALL_RADIUS, BALL_COLOR);
}


// move the ball left and right
void ballRoll(void){
    // BMA222 device address and X-axis register
    const unsigned char DEV_ADDR = 0x18;
    unsigned char reg = 0x03;
    unsigned char x_raw = 0;


    I2C_IF_Write(DEV_ADDR, &reg, 1, 0);
    I2C_IF_Read(DEV_ADDR, &x_raw, 1);

    // Convert to signed
    int ax = (signed char)x_raw;


    const int DEADZONE    = 6;    // ignore small noise near flat
    const int SCALE_SHIFT = 4;

    int dx = 0;
    if (ax > DEADZONE) {
        dx = (ax - DEADZONE) >> SCALE_SHIFT;   // faster right
        if (dx < 1) dx = 1;
    } else if (ax < -DEADZONE) {
        dx = (ax + DEADZONE) >> SCALE_SHIFT;   // faster left
        if (dx > -1) dx = -1;
    } else {
        dx = 0;                                 // stationary
    }

    ball_x += dx;

    // Clamp so ball never goes off-screen
    ball_x = clamp_int(ball_x,
                       BALL_RADIUS,
                       (OLED_WIDTH - 1) - BALL_RADIUS);
}

// move the ball up and down
void ballPitch(void){

}


void checkoffLoop(void){

    drawBall();

    while(1){

        delay(50);
    }
}


